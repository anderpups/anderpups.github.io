<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Quest: The Malfunctioning Magic</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* Dark background */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            color: #e2e8f0; /* Light text */
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
        }
        .game-container {
            background-color: #2d3748; /* Slightly lighter dark background for container */
            border: 4px solid #4a5568;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            width: 100%;
            max-width: 800px; /* Limit container width */
        }
        canvas {
            background-color: #000; /* Game world background */
            border: 2px solid #63b3ed; /* Blue border for canvas */
            border-radius: 8px;
            display: block;
            width: 100%; /* Make canvas responsive */
            max-width: 700px; /* Max width for canvas */
            height: auto; /* Maintain aspect ratio */
            aspect-ratio: 1.5 / 1; /* Wider aspect ratio for larger map */
        }
        .game-info {
            width: 100%;
            max-width: 700px;
            background-color: #4a5568;
            padding: 15px;
            border-radius: 8px;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        .controls-info {
            margin-top: 10px;
            font-size: 0.9em;
            color: #cbd5e0;
        }
        .message-box {
            background-color: #2b6cb0; /* Blue for messages */
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            margin-top: 10px;
            width: 100%;
            max-width: 700px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            display: none; /* Hidden by default */
        }
        .win-message {
            background-color: #48bb78; /* Green for win message */
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
            width: 100%;
            max-width: 700px;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.4);
            display: none; /* Hidden by default */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 flex flex-col items-center justify-center min-h-screen p-5">
    <div class="game-container">
        <h1 class="text-3xl font-bold text-blue-400 mb-4">Universal Quest: The Malfunctioning Magic</h1>
        <canvas id="gameCanvas"></canvas>
        <div id="messageBox" class="message-box"></div>
        <div id="winMessage" class="win-message"></div>
        <div class="game-info">
            <p id="inventoryDisplay" class="font-semibold">Inventory: None</p>
            <p class="controls-info">Use <span class="font-bold text-yellow-300">Arrow Keys</span> to Move. Press <span class="font-bold text-yellow-300">'E'</span> to Interact.</p>
        </div>
    </div>

    <script>
        // Get the canvas and its 2D rendering context
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // Game settings
        const tileSize = 32; // Size of each tile in pixels
        const mapWidth = 25; // Map width in tiles (increased)
        const mapHeight = 15; // Map height in tiles

        // Set canvas dimensions based on tile size and map dimensions
        canvas.width = mapWidth * tileSize;
        canvas.height = mapHeight * tileSize;

        // Player object
        const player = {
            x: 2, // Player's starting X position (in tiles)
            y: 2, // Player's starting Y position (in tiles)
            width: tileSize,
            height: tileSize,
            color: '#63b3ed', // Player color (blue)
            icon: '🚶' // Player icon (walking person emoji)
        };

        // Game state variables
        let inventory = []; // Array to hold collected items
        let messageQueue = []; // Queue for messages
        let currentMessageTimeout = null; // To manage message display time
        let ridesExperienced = 0;
        const totalRides = 3; // Number of interactive rides

        // Game map (0: walkable, 1: wall, 2: item, 3: interactive object, 4: opened barrier)
        // This represents a simplified section of Universal Studios, with distinct zones.
        // Try to imagine it as a top-down view of different park areas.
        const gameMap = [
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
            [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]
        ];

        // Custom map layout for distinct areas and paths
        // Walls to create zones
        for (let y = 0; y < mapHeight; y++) {
            gameMap[y][0] = 1; // Left border
            gameMap[y][mapWidth - 1] = 1; // Right border
        }
        for (let x = 0; x < mapWidth; x++) {
            gameMap[0][x] = 1; // Top border
            gameMap[mapHeight - 1][x] = 1; // Bottom border
        }

        // Create a central path
        for (let x = 1; x < mapWidth - 1; x++) {
            gameMap[7][x] = 0; // Horizontal path
        }
        for (let y = 1; y < mapHeight - 1; y++) {
            gameMap[y][12] = 0; // Vertical path
        }

        // Add some internal walls to define zones
        gameMap[5][5] = 1; gameMap[5][6] = 1; gameMap[5][7] = 1; gameMap[6][7] = 1;
        gameMap[8][4] = 1; gameMap[9][4] = 1; gameMap[10][4] = 1; gameMap[10][5] = 1;

        // Place items
        const items = [
            { x: 2, y: 10, type: 'Wand', icon: '✨', collected: false }, // Wand in a corner
            { x: 20, y: 3, type: 'Park Pass', icon: '🎫', collected: false }, // Park Pass near a ride
            { x: 5, y: 13, type: 'Courage Charm', icon: '🛡️', collected: false } // Courage Charm in another area
        ];

        // Place interactive objects (rides and barriers)
        const interactiveObjects = [
            // Magical Barrier blocking a path
            { x: 12, y: 6, type: 'Magical Barrier', icon: '🔒', opened: false, requiredItem: 'Wand', message: "A shimmering barrier blocks your way. It seems to react to magic." },
            // Hogwarts Express
            { x: 18, y: 2, type: 'Hogwarts Express', icon: '🚂', activated: false, requiredItem: 'Park Pass', message: "The Hogwarts Express awaits! All aboard for a magical journey!", activatedMessage: "You've already ridden the Hogwarts Express! It was enchanting." },
            // The Simpsons Ride
            { x: 3, y: 4, type: 'The Simpsons Ride', icon: '🍩', activated: false, requiredItem: 'Park Pass', message: "Welcome to Krustyland! Get ready for a wild ride with the Simpsons!", activatedMessage: "You've already experienced The Simpsons Ride! D'oh!" },
            // Velocicoaster
            { x: 20, y: 10, type: 'Velocicoaster', icon: '🎢', activated: false, requiredItem: 'Courage Charm', message: "Feel the rush! The Velocicoaster roars to life!", activatedMessage: "You've already braved the Velocicoaster! What a thrill!" }
        ];

        // Get DOM elements
        const inventoryDisplay = document.getElementById('inventoryDisplay');
        const messageBox = document.getElementById('messageBox');
        const winMessage = document.getElementById('winMessage');

        // Function to display a message in the message box
        function showMessage(text, duration = 3000) {
            // Clear any existing message timeout
            if (currentMessageTimeout) {
                clearTimeout(currentMessageTimeout);
            }

            messageBox.textContent = text;
            messageBox.style.display = 'block'; // Show the message box

            // Set a timeout to hide the message after a duration
            currentMessageTimeout = setTimeout(() => {
                messageBox.style.display = 'none'; // Hide the message box
                messageBox.textContent = ''; // Clear text
                currentMessageTimeout = null;
            }, duration);
        }

        // Function to update the inventory display
        function updateInventoryDisplay() {
            if (inventory.length === 0) {
                inventoryDisplay.textContent = 'Inventory: None';
            } else {
                inventoryDisplay.textContent = 'Inventory: ' + inventory.map(item => item.type).join(', ');
            }
        }

        // Function to draw the game world
        function draw() {
            // Clear the canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw the map
            for (let y = 0; y < mapHeight; y++) {
                for (let x = 0; x < mapWidth; x++) {
                    const tileType = gameMap[y][x];
                    if (tileType === 1) { // Wall
                        ctx.fillStyle = '#4a5568'; // Dark gray for walls
                    } else { // Walkable path or opened barrier
                        ctx.fillStyle = '#2d3748'; // Lighter dark background for paths
                    }
                    ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);
                }
            }

            // Draw items
            items.forEach(item => {
                if (!item.collected) {
                    ctx.font = `${tileSize * 0.7}px Arial`; // Larger font for emojis
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(item.icon, item.x * tileSize + tileSize / 2, item.y * tileSize + tileSize / 2);
                }
            });

            // Draw interactive objects
            interactiveObjects.forEach(obj => {
                if (!obj.opened && !obj.activated) { // Only draw if not opened/activated
                    ctx.fillStyle = '#a0aec0'; // Default color for interactive objects
                    ctx.fillRect(obj.x * tileSize, obj.y * tileSize, tileSize, tileSize);
                    ctx.font = `${tileSize * 0.6}px Arial`; // Larger font for emojis/text
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillStyle = '#fff'; // White for icon/text
                    ctx.fillText(obj.icon, obj.x * tileSize + tileSize / 2, obj.y * tileSize + tileSize / 2);

                    // Add a small text label for clarity
                    ctx.font = '8px Inter';
                    ctx.fillText(obj.type, obj.x * tileSize + tileSize / 2, obj.y * tileSize + tileSize * 0.85);
                }
            });

            // Draw player
            ctx.font = `${tileSize * 0.8}px Arial`; // Larger font for player emoji
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(player.icon, player.x * tileSize + tileSize / 2, player.y * tileSize + tileSize / 2);
        }

        // Handle keyboard input
        document.addEventListener('keydown', (e) => {
            let newPlayerX = player.x;
            let newPlayerY = player.y;

            switch (e.key) {
                case 'ArrowUp':
                    newPlayerY--;
                    break;
                case 'ArrowDown':
                    newPlayerY++;
                    break;
                case 'ArrowLeft':
                    newPlayerX--;
                    break;
                case 'ArrowRight':
                    newPlayerX++;
                    break;
                case 'e': // 'E' for interact
                case 'E':
                    interact();
                    break;
            }

            // Check for collisions before moving
            if (isValidMove(newPlayerX, newPlayerY)) {
                player.x = newPlayerX;
                player.y = newPlayerY;
            }

            // Redraw the game after player movement
            draw();
        });

        // Check if a move is valid (not into a wall or unopened barrier/ride)
        function isValidMove(x, y) {
            // Check map boundaries
            if (x < 0 || x >= mapWidth || y < 0 || y >= mapHeight) {
                return false;
            }

            const tileType = gameMap[y][x];
            if (tileType === 1) { // It's a wall
                return false;
            }

            // Check if it's an unopened interactive object (like a barrier or ride entrance)
            for (const obj of interactiveObjects) {
                if (obj.x === x && obj.y === y && (!obj.opened && !obj.activated)) {
                    return false; // Cannot move onto an unopened barrier or unactivated ride
                }
            }

            return true;
        }

        // Handle interaction
        function interact() {
            // Check for items at player's current position
            for (const item of items) {
                if (player.x === item.x && player.y === item.y && !item.collected) {
                    inventory.push(item);
                    item.collected = true;
                    updateInventoryDisplay();
                    showMessage(`You found the ${item.type}! ${item.icon}`, 4000);
                    draw(); // Redraw immediately to show item gone
                    return; // Only interact with one item at a time
                }
            }

            // Check for interactive objects adjacent to the player
            const adjacentPositions = [
                { x: player.x, y: player.y - 1 }, // Up
                { x: player.x, y: player.y + 1 }, // Down
                { x: player.x - 1, y: player.y }, // Left
                { x: player.x + 1, y: player.y }  // Right
            ];

            for (const pos of adjacentPositions) {
                for (const obj of interactiveObjects) {
                    if (pos.x === obj.x && pos.y === obj.y) {
                        if (obj.type === 'Magical Barrier' && !obj.opened) {
                            // Interaction with Magical Barrier
                            if (inventory.some(item => item.type === obj.requiredItem)) {
                                obj.opened = true;
                                // Change the map tile to walkable (type 4 for opened barrier)
                                gameMap[obj.y][obj.x] = 4;
                                showMessage(`You used the ${obj.requiredItem} to open the ${obj.type}! The path is clear.`, 5000);
                                draw(); // Redraw to show barrier gone
                                return;
                            } else {
                                showMessage(`${obj.message} You need a ${obj.requiredItem} to open it.`, 4000);
                                return;
                            }
                        } else if (obj.type !== 'Magical Barrier' && !obj.activated) {
                            // Interaction with a Ride
                            if (inventory.some(item => item.type === obj.requiredItem)) {
                                obj.activated = true;
                                ridesExperienced++;
                                showMessage(obj.message, 5000);
                                updateInventoryDisplay();
                                draw(); // Redraw to potentially show ride "activated" state (e.g., icon change)
                                checkWinCondition();
                                return;
                            } else {
                                showMessage(`You can't ride the ${obj.type} yet. You need a ${obj.requiredItem}.`, 4000);
                                return;
                            }
                        } else if (obj.activated) {
                            // Already activated ride
                            showMessage(obj.activatedMessage, 3000);
                            return;
                        } else if (obj.opened) {
                            // Already opened barrier
                            showMessage("This path is already open.", 2000);
                            return;
                        }
                    }
                }
            }

            // If no interaction happened
            showMessage("Nothing to interact with here.", 2000);
        }

        function checkWinCondition() {
            if (ridesExperienced >= totalRides) {
                winMessage.textContent = "Congratulations! You've experienced all the major rides and saved Universal Orlando Resort!";
                winMessage.style.display = 'block';
                // Optionally disable controls or reset game here
            }
        }

        // Initial draw when the page loads
        window.onload = function() {
            draw();
            updateInventoryDisplay();
            showMessage("Welcome to Universal Quest! Find items to activate rides and explore the resort.", 6000);
        };

        // Handle window resizing to keep canvas responsive (optional, but good for mobile)
        window.addEventListener('resize', () => {
            // Re-calculate max width and adjust canvas if needed
            const gameContainer = document.querySelector('.game-container');
            const maxCanvasWidth = Math.min(700, gameContainer.offsetWidth - 40); // 40px for padding
            canvas.style.maxWidth = `${maxCanvasWidth}px`;
            canvas.style.height = `${maxCanvasWidth * (mapHeight / mapWidth)}px`; // Maintain aspect ratio
            draw(); // Redraw on resize
        });

        // Call resize once on load to set initial responsive size
        window.dispatchEvent(new Event('resize'));

    </script>
</body>
</html>
